<!-- STORY LIST -->
<div class="story-list max-w-9xl mx-auto p-6 bg-white rounded-lg shadow-md">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-gray-800">Stories</h2>
    <button
      (click)="openModal()"
      class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
    >
      Add Story
    </button>
  </div>

  <input
    type="text"
    placeholder="Search stories..."
    (input)="onFilterChange($any($event.target).value)"
    class="border border-gray-300 rounded-md px-4 py-2 mb-4 w-full"
  />



  <table class="w-full table-auto border-collapse border border-gray-300">
  <thead class="bg-gray-100">
    <tr>
      <th class="border border-gray-300 px-4 py-2 text-left">Title</th>
      <th class="border border-gray-300 px-4 py-2 text-left">Source</th>
      <th class="border border-gray-300 px-4 py-2 text-left">Published Date</th>
      <th class="border border-gray-300 px-4 py-2 text-left">URL</th>
      <th class="border border-gray-300 px-4 py-2 text-left">Tagged Companies</th>
      <th class="border border-gray-300 px-4 py-2 text-left">Actions</th>
    </tr>
  </thead>

  <tbody>
    <!-- Spinner row -->
    <div *ngIf="isLoadingStories" class="fixed inset-0 bg-white bg-opacity-75 flex justify-center items-center z-50">
      <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
    </div>


    <!-- Story rows -->
    <tr *ngFor="let story of filteredStories" class="hover:bg-gray-50">
      <td class="border border-gray-300 px-4 py-2">{{ story.title }}</td>
      <td class="border border-gray-300 px-4 py-2">{{ story.source?.name ?? 'No source available' }}</td>
      <td class="border border-gray-300 px-4 py-2">{{ story.published_date | date: 'shortDate' }}</td>
      <td class="border border-gray-300 px-4 py-2">
        <a [href]="story.url" target="_blank" class="text-blue-600 hover:underline">Link</a>
      </td>
      <td class="border border-gray-300 px-4 py-2">
        <ng-container *ngIf="story.tagged_companies && story.tagged_companies.length > 0; else noCompanies">
          <span *ngFor="let company of story.tagged_companies; let i = index" class="inline-block">
            {{ company.name }}<span *ngIf="i < story.tagged_companies.length - 1">, </span>
          </span>
        </ng-container>
        <ng-template #noCompanies>
          <span class="text-gray-500 italic">No companies tagged</span>
        </ng-template>
      </td>

      <td class="border border-gray-300 px-4 py-2 space-x-2">
        <button
          (click)="fetchStory(story.id)"
          class="bg-yellow-400 hover:bg-yellow-500 text-white px-3 py-1 rounded focus:outline-none focus:ring-2 focus:ring-yellow-300"
        >
          Edit
        </button>
        <button
          (click)="openDeleteModal(story.id)"
          class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded focus:outline-none focus:ring-2 focus:ring-red-400"
        >
          Delete
        </button>
      </td>
    </tr>
  </tbody>
</table>

</div>

<!-- ADD STORY MODAL -->
<div
  *ngIf="showModal"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  role="dialog"
  aria-modal="true"
>
  <div
    class="bg-white rounded-lg shadow-lg p-6 w-full max-w-lg mx-4 relative"
  >
    <h3 class="text-xl font-semibold mb-4 text-gray-800">Add Story</h3>
    <form (ngSubmit)="addStory()" class="space-y-4">
      <!-- Title -->
      <div>
        <label class="block mb-1 font-medium text-gray-700">Title:</label>
        <input
          type="text"
          [(ngModel)]="newStory.title"
          name="title"
          required
          class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
        />
      </div>

      <!-- Source -->
      <!-- <div>
        <label class="block mb-1 font-medium text-gray-700">Source:</label>
        <select
          [(ngModel)]="newStory.source"
          name="source"
          required
          class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
        >
          <option *ngFor="let source of sources" [ngValue]="source">{{
            source.name
          }}</option>
        </select>
      </div> -->

      <!-- Published Date -->
      <div>
        <label class="block mb-1 font-medium text-gray-700">Published Date:</label>
        <input
          type="date"
          [(ngModel)]="newStory.published_date"
          name="published_date"
          required
          class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
        />
      </div>

      <!-- URL -->
      <div>
        <label class="block mb-1 font-medium text-gray-700">URL:</label>
        <input
          type="url"
          [(ngModel)]="newStory.url"
          name="url"
          required
          class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
        />
      </div>

      <!-- Body Text -->
      <div>
        <label class="block mb-1 font-medium text-gray-700">Body Text:</label>
        <textarea
          [(ngModel)]="newStory.body_text"
          name="body_text"
          required
          rows="4"
          class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
        ></textarea>
      </div>

      <!-- Tagged Companies (search input + dropdown) -->
      <div class="relative">
        <label class="block mb-1 font-medium text-gray-700">Tagged Companies:</label>
        <input
          type="text"
          placeholder="Search companies"
          [(ngModel)]="companySearch"
          (input)="filterCompanies()"
          name="companySearch"
          autocomplete="off"
          class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
        />
        <div
          *ngIf="filteredCompanies.length > 0"
          class="absolute z-10 mt-1 max-h-40 w-full overflow-auto rounded-md border border-gray-300 bg-white shadow-lg"
        >
          <div
            *ngFor="let company of filteredCompanies"
            (click)="addCompanyToNewStory(company)"
            tabindex="0"
            role="button"
            class="cursor-pointer px-3 py-2 hover:bg-blue-100 focus:bg-blue-100 select-none"
          >
            {{ company.name }}
          </div>
        </div>
      </div>

      <!-- Selected tagged companies badges -->
      <div class="mt-2 flex flex-wrap gap-2">
        <span
          *ngFor="let company of newStory.tagged_companies; let i = index"
          class="bg-blue-200 text-blue-800 px-3 py-1 rounded-full flex items-center gap-2"
        >
          {{ company.name }}
          <button
            type="button"
            (click)="removeCompanyFromNewStory(i)"
            class="ml-1 text-red-600 hover:text-red-900 focus:outline-none"
            aria-label="Remove company"
          >
            &times;
          </button>
        </span>
      </div>

      <!-- Buttons -->
      <div class="flex justify-end gap-3 mt-6">
        <button
          type="submit"
          class="bg-green-600 text-white px-5 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400"
        >
          Add
        </button>
        <button
          type="button"
          (click)="closeModal()"
          class="bg-gray-300 text-gray-800 px-5 py-2 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>


<!-- EDIT STORY MODAL -->
<div
  *ngIf="showEditModal"
  class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center px-4"
  role="dialog"
  aria-modal="true"
>
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Edit Story</h2>

    <form (ngSubmit)="updateStory()" class="space-y-4">
      <!-- Title -->
      <div>
        <label for="editTitle" class="block text-sm font-medium text-gray-700">Title</label>
        <input
          id="editTitle"
          type="text"
          [(ngModel)]="editStory.title"
          name="editTitle"
          required
          class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-yellow-500 focus:outline-none"
        />
      </div>

      <!-- Published Date -->
      <div>
        <label for="editPublishedDate" class="block text-sm font-medium text-gray-700">Published Date</label>
        <input
          id="editPublishedDate"
          type="date"
          [(ngModel)]="editStory.published_date"
          name="editPublishedDate"
          required
          class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-yellow-500 focus:outline-none"
        />
      </div>

      <!-- URL -->
      <div>
        <label for="editUrl" class="block text-sm font-medium text-gray-700">URL</label>
        <input
          id="editUrl"
          type="url"
          [(ngModel)]="editStory.url"
          name="editUrl"
          required
          class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-yellow-500 focus:outline-none"
        />
      </div>

      <!-- Body Text -->
      <div>
        <label for="editBodyText" class="block text-sm font-medium text-gray-700">Body Text</label>
        <textarea
          id="editBodyText"
          [(ngModel)]="editStory.body_text"
          name="editBodyText"
          rows="4"
          required
          class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-yellow-500 focus:outline-none"
        ></textarea>
      </div>

      <!-- Tagged Companies -->
      <div class="relative">
      <label class="block text-sm font-medium text-gray-700 mb-1">Tagged Companies</label>
        <!-- Search input -->
        <input
          type="text"
          placeholder="Search companies"
          [(ngModel)]="editCompanySearch"
          (input)="filterEditCompanies()"
          name="editCompanySearch"
          autocomplete="off"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
        />

         <!-- Suggestions dropdown -->
        <div
          *ngIf="editFilteredCompanies.length > 0"
          class="absolute mt-1 w-full bg-white border border-gray-200 shadow-lg rounded-md max-h-48 overflow-y-auto z-10"
        >
          <div
            *ngFor="let company of editFilteredCompanies"
            (click)="addCompanyToEditStory(company)"
            class="px-3 py-2 cursor-pointer hover:bg-yellow-100"
          >
            {{ company.name }}
          </div>
        </div>

              <!-- Selected Company Tags -->
          <div class="mt-2 flex flex-wrap gap-2">
              <span
                *ngFor="let company of editStory.tagged_companies"
                class="flex items-center bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-sm"
              >
                {{ company.name }}
                <button
                  type="button"
                  (click)="removeCompanyFromEditStory(company)"
                  class="ml-1 text-yellow-600 hover:text-yellow-800"
                  aria-label="Remove"
                >
                  &times;
                </button>
              </span>
          </div>
      </div>

      <!-- Footer Buttons -->
      <div class="pt-4 flex justify-end gap-3">
        <button
          type="submit"
          class="bg-yellow-500 text-white px-5 py-2 rounded-md hover:bg-yellow-600 focus:ring-2 focus:ring-yellow-300 focus:outline-none"
        >
          Update
        </button>
        <button
          type="button"
          (click)="closeEditModal()"
          class="bg-gray-300 text-gray-800 px-5 py-2 rounded-md hover:bg-gray-400 focus:outline-none"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<!-- DELETE CONFIRM MODAL -->
<div *ngIf="showDeleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" role="alertdialog" aria-modal="true" aria-labelledby="deleteTitle" aria-describedby="deleteDesc">
  <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-lg mx-4 relative max-w-sm text-center">
    <p id="deleteDesc" class="mb-6 text-gray-700 text-lg">Are you sure you want to delete this story?</p>
    <div class="flex justify-center gap-6">
      <button
        (click)="confirmDelete()"
        class="bg-red-600 text-white px-6 py-2 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400"
      >
        Yes
      </button>
      <button
        (click)="closeDeleteModal()"
        class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400"
      >
        No
      </button>
    </div>
  </div>
</div>

<div class="flex items-center justify-between mt-4">
  <!-- Prev Button -->
  <button
    (click)="prevPage()"
    [disabled]="!hasPrev"
    class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50"
  >
    Previous
  </button>

  <!-- Next Button -->
  <button
    (click)="nextPage()"
    [disabled]="!hasNext"
    class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50"
  >
    Next
  </button>
</div>
