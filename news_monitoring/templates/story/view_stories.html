{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
    <h1 class="text-3xl font-semibold mb-6">Stories</h1>

    <!-- Search Bar -->
    <form method="get" action="{% url 'story:view_stories' %}" class="mb-6 flex">
        <input type="text" name="q" value="{{ query }}" placeholder="Search by title or body text"
               class="w-full border border-gray-300 px-4 py-2 rounded-l" />
        <button type="submit" class="bg-blue-600 text-white px-10 py-2 rounded-r hover:bg-blue-700">
            Search
        </button>
    </form>

    <!-- Add Story Button -->
    <div class="mb-4 text-right">
        <a href="{% url 'story:add_story' %}"
           class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">+ Add New Story</a>
    </div>

    <!-- Story List -->
    <div class="space-y-6">
        {% if stories %}
            {% for story in stories %}
                <div class="border p-4 rounded shadow hover:shadow-md transition">
                    <h2 class="text-xl font-bold">
                        <a href="{{ story.url }}" target="_blank" class="text-blue-700 hover:underline">
                            {{ story.title }}
                        </a>
                    </h2>
                    <p class="text-sm text-gray-600 mb-1">
                        <strong>Source:</strong> {{ story.source.name|default:"N/A" }} |
                        <strong>Published:</strong> {{ story.published_date|date:"Y-m-d H:i" }}
                    </p>
                    <p class="mb-2">
                        {{ story.body_text|truncatechars:250 }}
                    </p>
                    <p class="text-sm text-gray-700">
                        <strong>Tagged Companies:</strong>
                        {% for company in story.tagged_companies.all %}
                            <span class="inline-block bg-gray-200 px-2 py-1 rounded mr-1 text-sm">
                                {{ company.name }}
                            </span>
                        {% empty %}
                            <span>No companies tagged.</span>
                        {% endfor %}
                    </p>
                    <div class="mt-3 flex space-x-2">
                        <a href="{% url 'story:update_story' story.pk %}" class="text-blue-600 hover:underline">Edit</a>
                        <form method="post" action="{% url 'story:delete_story' story.pk %}" onsubmit="return confirm('Are you sure you want to delete this story?');">
                            {% csrf_token %}
                            <button type="submit" class="text-red-600 hover:underline">Delete</button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p class="text-gray-600">No stories found.</p>
        {% endif %}
    </div>

    <!-- Pagination Controls -->
    {% if total_pages > 1 %}
    <div class="flex justify-center space-x-4 mt-4">
        {% if page_number > 1 %}
            <a href="?q={{ query }}&page={{ page_number|add:"-1" }}" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Prev</a>
        {% else %}
            <span class="px-4 py-2 bg-gray-200 rounded text-gray-500 cursor-not-allowed">Prev</span>
        {% endif %}

        <span class="self-center text-sm">Page {{ page_number }} of {{ total_pages }}</span>

        {% if page_number < total_pages %}
            <a href="?q={{ query }}&page={{ page_number|add:"1" }}" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Next</a>
        {% else %}
            <span class="px-4 py-2 bg-gray-200 rounded text-gray-500 cursor-not-allowed">Next</span>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}
