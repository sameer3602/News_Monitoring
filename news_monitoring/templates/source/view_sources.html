{% extends 'base.html' %}
{% block title %}Sources{% endblock %}

{% block content %}
<h2 class="text-2xl font-bold mb-4">Sources</h2>
<table id="sourcesTable" class="table-auto w-full bg-white shadow-md rounded-lg overflow-hidden">
    <thead class="bg-gray-100">
        <tr>
            <th class="border px-4 py-2 text-left">Name</th>
            <th class="border px-4 py-2 text-left">URL</th>
            <th class="border px-4 py-2 text-left">Company</th>
            <th class="border px-4 py-2 text-left">Tagged Companies</th>
            <th class="border px-4 py-2 text-left">Actions</th>
        </tr>
    </thead>
    <tbody>
        <!-- Data will be inserted here by AJAX -->
    </tbody>
</table>
<div class="flex justify-center space-x-4 mt-4 items-center" id="pagination-controls">
    <button id="prevPage" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Prev</button>
    <span id="pageNumber" class="px-4 py-2 font-medium text-gray-700">Page 1</span>
    <button id="nextPage" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Next</button>
</div>


<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg w-96">
        <h3 class="text-lg font-bold mb-4">Confirm Deletion</h3>
        <p class="mb-6">Are you sure you want to delete this source?</p>
        <div class="flex justify-end space-x-4">
            <button id="cancelDelete" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
            <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function() {
    let currentPage = 1;
    let totalPages = 1;

    function fetchSources(page = 1) {
        $.ajax({
            url: "{% url 'source:get_sources' %}",
            method: "GET",
            data: { page: page },
            success: function(response) {
                const sources = response.sources;
                let sourceRows = '';

                sources.forEach(function(source) {
                    sourceRows += `
                        <tr class="hover:bg-gray-50" id="source-row-${source.pk}">
                            <td class="border px-4 py-2">${source.name}</td>
                            <td class="border px-4 py-2">
                                <a href="${source.url}" target="_blank" class="text-blue-600 hover:text-blue-800">${source.url}</a>
                            </td>
                            <td class="border px-4 py-2">${source.company.name}</td>
                            <td class="border px-4 py-2">${source.tagged_companies.join(', ')}</td>
                            <td class="border px-4 py-2">
                                <div class="flex space-x-4">
                                    <a href="/sources/update/${source.pk}/" class="text-blue-600 hover:text-blue-800">Edit</a>
                                    <button class="text-red-600 hover:text-red-800 delete-btn" data-id="${source.pk}">Delete</button>
                                    <button class="text-green-600 hover:text-green-800 fetch-btn" data-id="${source.pk}">Fetch</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                $('#sourcesTable tbody').html(sourceRows);

                // Update pagination state
                currentPage = response.page_number;
                totalPages = response.total_pages;

                // Update page number display
                $('#pageNumber').text(`Page ${currentPage} of ${totalPages}`);

                // Show/hide pagination buttons
                if (response.has_previous) {
                    $('#prevPage').show();
                } else {
                    $('#prevPage').hide();
                }

                if (response.has_next) {
                    $('#nextPage').show();
                } else {
                    $('#nextPage').hide();
                }
            },
            error: function(xhr, status, error) {
                console.log("Error fetching sources:", error);
            }
        });
    }

    // Initial fetch
    fetchSources();

    // Pagination button events
    $('#prevPage').on('click', function() {
        if (currentPage > 1) {
            fetchSources(currentPage - 1);
        }
    });

    $('#nextPage').on('click', function() {
        if (currentPage < totalPages) {
            fetchSources(currentPage + 1);
        }
    });

    // Delete modal logic
    let sourceToDelete = null;
    $(document).on('click', '.delete-btn', function() {
        sourceToDelete = $(this).data('id');
        $('#deleteModal').removeClass('hidden').addClass('flex');
    });

    $('#cancelDelete').on('click', function() {
        sourceToDelete = null;
        $('#deleteModal').addClass('hidden').removeClass('flex');
    });

    $('#confirmDelete').on('click', function() {
        if (sourceToDelete !== null) {
            $.ajax({
                url: `/sources/delete/${sourceToDelete}/`,
                method: 'DELETE',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                success: function() {
                    fetchSources(currentPage);
                    $('#deleteModal').addClass('hidden').removeClass('flex');
                    sourceToDelete = null;
                },
                error: function(xhr, status, error) {
                    console.log("Error deleting source:", error);
                    $('#deleteModal').addClass('hidden').removeClass('flex');
                }
            });
        }
    });

    // Fetch RSS stories
    $(document).on('click', '.fetch-btn', function () {
        const sourceId = $(this).data('id');
        $.ajax({
            url: "{% url 'source:fetch_rss' %}",
            method: "GET",
            data: {
                source_id: sourceId,
                csrfmiddlewaretoken: "{{ csrf_token }}"
            },
            success: function (response) {
                alert(response.message);
            },
            error: function () {
                alert("Failed to fetch stories from RSS.");
            }
        });
    });
});

</script>
{% endblock %}
